<main class="flex-1 px-10 py-8">
  <div class="flex justify-between items-end mb-10">
    <h1 class="text-4xl font-light tracking-tight">All Credentials</h1>

    <button
      (click)="openAddModal()"
      class="cursor-pointer flex items-center gap-2 px-4 py-2 bg-zinc-50 text-zinc-950 rounded-full hover:bg-zinc-200 transition-all font-medium text-sm active:scale-95"
    >
      <span class="text-lg">+</span> Add Credential
    </button>
  </div>

  @if (isLoading()) {
    <div class="flex flex-col items-center justify-center py-20 space-y-4">
      <div class="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-neutral-500 font-light tracking-wide">Decrypting your vault...</p>
    </div>
  } @else {

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      @for (item of filteredItems(); track item.id) {
        <div
          (click)="selectItem(item)"
          class="group relative flex flex-col justify-between p-6 bg-zinc-900/40 border border-neutral-800 rounded-2xl cursor-pointer hover:border-amber-500/50 hover:bg-zinc-900/60 transition-all duration-300"
        >
          <div>
            <div class="flex justify-between items-start mb-4">
              <div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center text-zinc-400 group-hover:text-amber-500 transition-colors">
                <span class="text-xl font-mono">{{ item.title.charAt(0).toUpperCase() }}</span>
              </div>
              
              @if (item.ownerId !== vaultState.user()?.id) {
                <span
                  class="text-[9px] bg-amber-600/10 text-amber-500 px-2 py-1 rounded-md border border-amber-600/20 uppercase tracking-tighter"
                  [title]="'Shared by ' + item.ownerEmail"
                >
                  From: {{ item.ownerEmail }}
                </span>
              }
            </div>

            <h3 class="text-lg font-medium text-zinc-50 mb-1 truncate">{{ item.title }}</h3>
            <p class="text-sm text-neutral-400 truncate font-light">{{ item.username }}</p>
          </div>

          <div class="mt-8 pt-4 border-t border-neutral-800/50 flex justify-between items-center">
            <span class="text-[10px] text-neutral-500 uppercase tracking-widest">
              Updated {{ formatDate(item.updatedAt) }}
            </span>
            <span class="text-zinc-500 opacity-0 group-hover:opacity-100 transition-opacity text-xs">
              View →
            </span>
          </div>
        </div>
      } 
      
      @empty {
        <div class="col-span-full flex flex-col items-center justify-center py-20 border-2 border-dashed border-neutral-800 rounded-2xl">
          <p class="text-neutral-500 text-lg font-light">
            No credentials found matching "{{ vaultState.searchQuery() }}"
          </p>
        </div>
      }
    </div>
  }
</main>

@if (isAddModalOpen()) {
<div
  (click)="closeAddModal()"
  class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4"
>
  <div (click)="$event.stopPropagation()" class="w-full max-w-2xl">
    <app-credential (cancel)="closeAddModal()" />
  </div>
</div>
} @if (selectedItem()) {
<div
  (click)="closePopup()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"
>
  <section
    (click)="$event.stopPropagation()"
    class="bg-zinc-950 text-zinc-50 p-8 rounded-xl border border-neutral-800 w-full max-w-2xl shadow-2xl"
  >
    <h2 class="text-3xl font-light mb-8 tracking-tight text-center">
      {{ isEditMode() ? 'Edit Credential' : 'Credential Details' }}
    </h2>

    <div class="space-y-6">
      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest">Service</label>
        @if (isEditMode()) {
        <input
          [(ngModel)]="selectedItem().title"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none"
        />
        } @else {
        <p class="text-xl text-zinc-50">{{ selectedItem().title }}</p>
        }
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest"
          >Username</label
        >
        @if (isEditMode()) {
        <input
          [(ngModel)]="selectedItem().username"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none"
        />
        } @else {
        <div class="bg-zinc-900/50 p-3 rounded border border-neutral-800/50">
          <p class="text-zinc-50">{{ selectedItem().username }}</p>
        </div>
        }
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest"
          >Password</label
        >
        <div
          class="flex items-center justify-between bg-zinc-900 border border-neutral-800 rounded px-4 py-3"
        >
          @if (isEditMode()) {
          <input
            [(ngModel)]="selectedItem().password"
            [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
            [type]="showSecret() ? 'text' : 'password'"
            class="w-full bg-transparent text-zinc-50 focus:outline-none font-mono"
          />
          } @else {
          <p class="font-mono text-zinc-50">
            {{ showSecret() ? selectedItem().password : '••••••••••••' }}
          </p>
          }
          <button
            (click)="toggleSecret()"
            class="cursor-pointer text-neutral-400 hover:text-zinc-50 ml-2"
          >
            {{ showSecret() ? 'Hide' : 'Show' }}
          </button>
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest">Website</label>
        @if (isEditMode()) {
        <input
          [(ngModel)]="selectedItem().url"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none"
        />
        } @else {
        <div
          class="bg-zinc-900/30 p-4 rounded border border-neutral-800/50 truncate italic text-neutral-300"
        >
          <a [href]="selectedItem().url" target="_blank" class="hover:underline cursor-pointer">{{
            selectedItem().url || 'No URL saved'
          }}</a>
        </div>
        }
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest">Notes</label>
        @if (isEditMode()) {
        <textarea
          [(ngModel)]="selectedItem().notes"
          rows="3"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none resize-none"
        ></textarea>
        } @else {
        <div
          class="bg-zinc-900/30 p-4 rounded border border-neutral-800/50 italic text-neutral-300 min-h-[50px]"
        >
          {{ selectedItem().notes || 'No notes' }}
        </div>
        }
      </div>
    </div>

    @if (selectedItem().ownerId === vaultState.user()?.id && !isEditMode()) {
    <div class="mt-8 pt-6 border-t border-zinc-800">
      <label class="text-xs font-light text-amber-500 uppercase tracking-widest mb-4 block">
        Access Management
      </label>

      <div class="space-y-2 mb-4">
        @for (perm of accessList(); track perm.id) {
        <div class="flex justify-between items-center bg-zinc-900/30 px-3 py-2 rounded text-sm">
          <span class="text-zinc-400">{{ perm.user.email }}</span>
          @if (perm.user.id !== vaultState.user()?.id) {
          <button
            (click)="revokeAccess(perm.user.id)"
            class="text-red-500/50 hover:text-red-500 cursor-pointer"
          >
            ✕
          </button>
          } @else {
          <span class="text-[10px] text-zinc-600 uppercase">Owner</span>
          }
        </div>
        }
      </div>

      <div class="flex gap-2">
        <input
          [(ngModel)]="shareEmail"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          placeholder="Enter email to share..."
          class="flex-1 bg-transparent border-b border-zinc-800 focus:border-amber-500 outline-none py-1 text-sm text-zinc-300 transition-colors"
        />

        @if (!targetUser()) {
        <button
          (click)="checkUser()"
          [disabled]="isCheckingEmail() || !shareEmail()"
          class="text-amber-500 text-xs font-medium uppercase hover:text-amber-400 disabled:opacity-50 cursor-pointer"
        >
          {{ isCheckingEmail() ? 'Checking...' : 'Check Email' }}
        </button>
        } @else {
        <button
          (click)="grantAccess()"
          [disabled]="isSharing()"
          class="bg-amber-500 text-zinc-950 px-3 py-1 rounded text-xs font-bold hover:bg-amber-400 transition cursor-pointer"
        >
          {{ isSharing() ? 'Sharing...' : 'Grant Access' }}
        </button>
        }
      </div>
    </div>
    }

    <div class="mt-10 pt-6 border-t border-neutral-800 flex justify-between items-center">
      @if (isEditMode()) {
      <button
        (click)="toggleEdit()"
        class="text-sm text-neutral-400 hover:text-zinc-50 cursor-pointer"
      >
        Cancel
      </button>
      <button
        (click)="onUpdate()"
        [disabled]="isUpdating()"
        class="bg-zinc-50 text-zinc-950 px-6 py-2 rounded-full text-sm font-medium hover:bg-zinc-200 transition disabled:opacity-50 cursor-pointer"
      >
        {{ isUpdating() ? 'Updating...' : 'Save Changes' }}
      </button>
      } @else { @if (selectedItem()?.ownerId === vaultState.user()?.id) {
      <button
        (click)="onDelete()"
        class="cursor-pointer text-red-500/70 hover:text-red-500 uppercase tracking-widest text-xs"
      >
        Delete
      </button>

      <div class="flex gap-4">
        <button
          (click)="toggleEdit()"
          class="cursor-pointer text-blue-400 hover:text-blue-500 uppercase tracking-widest text-xs"
        >
          Edit
        </button>
        <button
          (click)="closePopup()"
          class="cursor-pointer text-neutral-400 hover:text-zinc-50 uppercase tracking-widest text-xs"
        >
          Close
        </button>
      </div>
      } @else {
      <div class="w-full flex justify-center">
        <button
          (click)="closePopup()"
          class="cursor-pointer text-neutral-400 hover:text-zinc-50 uppercase tracking-widest text-xs"
        >
          Close Detail
        </button>
      </div>
      } }
    </div>
  </section>
</div>
} @if (isAddModalOpen()) {
<div
  (click)="closeAddModal()"
  class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4"
>
  <div (click)="$event.stopPropagation()" class="w-full max-w-2xl">
    <app-credential (cancel)="closeAddModal()" />
  </div>
</div>
} @if (selectedItem()) {
<div
  (click)="closePopup()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"
>
  <section
    (click)="$event.stopPropagation()"
    class="bg-zinc-950 text-zinc-50 p-8 rounded-xl border border-neutral-800 w-full max-w-2xl shadow-2xl"
  >
    <h2 class="text-3xl font-light mb-8 tracking-tight text-center">
      {{ isEditMode() ? 'Edit Credential' : 'Credential Details' }}
    </h2>

    <div class="space-y-6">
      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest">Service</label>
        @if (isEditMode()) {
        <input
          [(ngModel)]="selectedItem().title"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none"
        />
        } @else {
        <p class="text-xl text-zinc-50">{{ selectedItem().title }}</p>
        }
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest"
          >Username</label
        >
        @if (isEditMode()) {
        <input
          [(ngModel)]="selectedItem().username"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none"
        />
        } @else {
        <div class="bg-zinc-900/50 p-3 rounded border border-neutral-800/50">
          <p class="text-zinc-50">{{ selectedItem().username }}</p>
        </div>
        }
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest"
          >Password</label
        >
        <div
          class="flex items-center justify-between bg-zinc-900 border border-neutral-800 rounded px-4 py-3"
        >
          @if (isEditMode()) {
          <input
            [(ngModel)]="selectedItem().password"
            [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
            [type]="showSecret() ? 'text' : 'password'"
            class="w-full bg-transparent text-zinc-50 focus:outline-none font-mono"
          />
          } @else {
          <p class="font-mono text-zinc-50">
            {{ showSecret() ? selectedItem().password : '••••••••••••' }}
          </p>
          }
          <button
            (click)="toggleSecret()"
            class="cursor-pointer text-neutral-400 hover:text-zinc-50 ml-2"
          >
            {{ showSecret() ? 'Hide' : 'Show' }}
          </button>
        </div>
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest">Website</label>
        @if (isEditMode()) {
        <input
          [(ngModel)]="selectedItem().url"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none"
        />
        } @else {
        <div
          class="bg-zinc-900/30 p-4 rounded border border-neutral-800/50 truncate italic text-neutral-300"
        >
          <a [href]="selectedItem().url" target="_blank" class="hover:underline cursor-pointer">{{
            selectedItem().url || 'No URL saved'
          }}</a>
        </div>
        }
      </div>

      <div class="space-y-1">
        <label class="text-xs font-light text-neutral-500 uppercase tracking-widest">Notes</label>
        @if (isEditMode()) {
        <textarea
          [(ngModel)]="selectedItem().notes"
          rows="3"
          class="w-full bg-zinc-900 border border-neutral-800 rounded px-3 py-2 text-zinc-50 focus:outline-none resize-none"
        ></textarea>
        } @else {
        <div
          class="bg-zinc-900/30 p-4 rounded border border-neutral-800/50 italic text-neutral-300 min-h-[50px]"
        >
          {{ selectedItem().notes || 'No notes' }}
        </div>
        }
      </div>
    </div>

    @if (selectedItem().ownerId === vaultState.user()?.id && !isEditMode()) {
    <div class="mt-8 pt-6 border-t border-zinc-800">
      <label class="text-xs font-light text-amber-500 uppercase tracking-widest mb-4 block">
        Access Management
      </label>

      <div class="space-y-2 mb-4">
        @for (perm of accessList(); track perm.id) {
        <div class="flex justify-between items-center bg-zinc-900/30 px-3 py-2 rounded text-sm">
          <span class="text-zinc-400">{{ perm.user.email }}</span>
          @if (perm.user.id !== vaultState.user()?.id) {
          <button
            (click)="revokeAccess(perm.user.id)"
            class="text-red-500/50 hover:text-red-500 cursor-pointer"
          >
            ✕
          </button>
          } @else {
          <span class="text-[10px] text-zinc-600 uppercase">Owner</span>
          }
        </div>
        }
      </div>

      <div class="flex gap-2">
        <input
          [(ngModel)]="shareEmail"
          [disabled]="selectedItem()?.ownerId !== vaultState.user()?.id"
          placeholder="Enter email to share..."
          class="flex-1 bg-transparent border-b border-zinc-800 focus:border-amber-500 outline-none py-1 text-sm text-zinc-300 transition-colors"
        />

        @if (!targetUser()) {
        <button
          (click)="checkUser()"
          [disabled]="isCheckingEmail() || !shareEmail()"
          class="text-amber-500 text-xs font-medium uppercase hover:text-amber-400 disabled:opacity-50 cursor-pointer"
        >
          {{ isCheckingEmail() ? 'Checking...' : 'Check Email' }}
        </button>
        } @else {
        <button
          (click)="grantAccess()"
          [disabled]="isSharing()"
          class="bg-amber-500 text-zinc-950 px-3 py-1 rounded text-xs font-bold hover:bg-amber-400 transition cursor-pointer"
        >
          {{ isSharing() ? 'Sharing...' : 'Grant Access' }}
        </button>
        }
      </div>
    </div>
    }

    <div class="mt-10 pt-6 border-t border-neutral-800 flex justify-between items-center">
      @if (isEditMode()) {
      <button
        (click)="toggleEdit()"
        class="text-sm text-neutral-400 hover:text-zinc-50 cursor-pointer"
      >
        Cancel
      </button>
      <button
        (click)="onUpdate()"
        [disabled]="isUpdating()"
        class="bg-zinc-50 text-zinc-950 px-6 py-2 rounded-full text-sm font-medium hover:bg-zinc-200 transition disabled:opacity-50 cursor-pointer"
      >
        {{ isUpdating() ? 'Updating...' : 'Save Changes' }}
      </button>
      } @else { @if (selectedItem()?.ownerId === vaultState.user()?.id) {
      <button
        (click)="onDelete()"
        class="cursor-pointer text-red-500/70 hover:text-red-500 uppercase tracking-widest text-xs"
      >
        Delete
      </button>

      <div class="flex gap-4">
        <button
          (click)="toggleEdit()"
          class="cursor-pointer text-blue-400 hover:text-blue-500 uppercase tracking-widest text-xs"
        >
          Edit
        </button>
        <button
          (click)="closePopup()"
          class="cursor-pointer text-neutral-400 hover:text-zinc-50 uppercase tracking-widest text-xs"
        >
          Close
        </button>
      </div>
      } @else {
      <div class="w-full flex justify-center">
        <button
          (click)="closePopup()"
          class="cursor-pointer text-neutral-400 hover:text-zinc-50 uppercase tracking-widest text-xs"
        >
          Close Detail
        </button>
      </div>
      } }
    </div>
  </section>
</div>
}
